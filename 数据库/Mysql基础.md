[TOC]
#  MySQL

## MyISAM与InnoDB的区别

|          |InnoDB    |MyISAM    |
| --- | --- | --- |
| 事务 | 支持 |不支持 |
| 锁 | 行级锁 | 表级锁 |
| MVCC | 支持 | 不支持 |
| 外键 | 支持 | 不支持 |
| 全文索引 | 不支持 | 支持 |
| 应用场景 | 1. 可靠性要求比较高，或者要求事务；<br/>2. 表更新和查询都相当的频繁，并且行锁定的机会比较大的情况。 | 1. 做很多count的计算；<br/>2. 插入不频繁，查询非常频繁；<br/>3. 没有事务。 |


## 主从复制原理

- binlog线程——记录下所有改变了数据库数据的语句，放进master上的binlog中；
- 从：io线程——在使用start slave 之后，负责从master上拉取 binlog 内容，放进 自己的relay log中；
- 从：sql执行线程——执行relay log中的语句

## binlog

- mysql-bin.0000XX（binlog）

  - 记录所有对数据库更改操作

  - 用途

    - 1.数据恢复

      2.复制，mysql的主从同步

      3.审计，用户可以通过二进制日志中的信息来进行审计判断是否有sql注入

  - 三种模式

    - Row
      - 记录哪一条记录被修改了，修改成什么信样，缺点是以每行的修改来记录，产生大量日志
    - Statement
      - 仅仅记录执行的语句，必须记录每条语句在执行的时候的一些相关信息，也就是上下文信息，以保证所有语句在slave端被执行的时候能够得到和在master端执行时候的结果。
    - Mixed
      - 表结构变更的时候就会以Statement模式来记录，如果sql语句确实是update或者delete等修改数据的语句，那么还是会记录所有行的变更。

## 数据文件

mysql-bin.0000XX（binlog）
表名.myd：mymisam引擎表数据
表名.myi：myisam引擎索引
表名.frm：数据表的结构定义。该文件在5.7以及之前的版本存在，在mysql8之后表结构都是存放在共享表空间中的，所以已经不存在frm文件了
表名字.idb：innodb引擎为数据文件
    
## SQL

### in和exist的区别

  - in会先查询子表，再将结果与主表做笛卡尔积，最后筛选出符合条件的，子表数据太大时不适合（效率：主表数目*子表数目）
  - 当子表比主表数据大时适合使用exists()，因为效率：主表数目

## FAQ
### CPU或者IO压力大，怎么定位问题

- 首先我会用top命令和iostat命令，定位是什么进程在占用cpu和磁盘io；
- 如果是mysql的问题，我会登录到数据库，通过show full - processlist命令，看现在数据库在执行什么sql语句，是否有语句长时间执行使数据库卡住；
- 执行show innodb engine status命令，查看数据库是否有锁资源争用；
- 查看mysql慢查询日志，看是否有慢sql；
- 找到引起数据库占用资源高的语句，进行优化，该建索引的建索引，索引不合适的删索引，或者根据情况kill掉耗费资源的sql语句等

### 为何关联查询会慢？

每个表都是一个idb文件，如果要关联查询多个表就需要读取多个文件，进行遍历比对，如果要加快速度，可以增加索引，加大join_buffer



### 幻读和不可重复读

 *幻读和不可重复读都是读取了另一条已经提交的事务(这点就脏读不同)，所不同的是不可重复读可能发生在update操作中，而幻读发生在insert，delete操作中。*
